<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>四字熟語マスター - スタンドアロン版</title>
    <!-- Tailwind CSS (デザイン) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (フォント) -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <!-- Babel (ブラウザ上でReactコードを動かすための変換器) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['"Zen Maru Gothic"', 'sans-serif'] },
            colors: {
              'japan-red': '#ff4057', 'japan-indigo': '#1e293b', 'pop-cyan': '#22d3ee',
              'pop-yellow': '#facc15', 'pop-purple': '#a855f7', 'pop-green': '#4ade80',
            },
            boxShadow: {
              'hard': '4px 4px 0px 0px #1e293b',
              'hard-sm': '2px 2px 0px 0px #1e293b',
              'hard-lg': '8px 8px 0px 0px #1e293b',
            },
            animation: {
              'bounce-in': 'bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
              'fade-in': 'fadeIn 0.3s ease-out forwards',
            },
            keyframes: {
              bounceIn: { '0%': { transform: 'scale(0.8)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
            }
          },
        },
      }
    </script>
    <style>
      body {
        background-color: #f1f5f9;
        color: #1e293b;
        background-image: radial-gradient(#cbd5e1 2px, transparent 2px);
        background-size: 24px 24px;
        overscroll-behavior-y: none;
        -webkit-tap-highlight-color: transparent;
      }
      #root { min-height: 100vh; display: flex; flex-direction: column; }
      .drag-overlay-card { z-index: 9999 !important; pointer-events: none; }
    </style>
    
    <!-- 必要なライブラリの定義 -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.0.0",
        "react-dom": "https://esm.sh/react-dom@19.0.0",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.463.0?external=react",
        "@dnd-kit/core": "https://esm.sh/@dnd-kit/core@6.1.0?external=react,react-dom",
        "@dnd-kit/utilities": "https://esm.sh/@dnd-kit/utilities@3.2.2?external=react,react-dom"
      }
    }
    </script>
  </head>
  <body>
    <div id="root"></div>

    <!-- ここにすべてのプログラムを集約 -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect } from 'react';
      import ReactDOM from 'react-dom/client';
      import { 
        Zap, Star, ChevronRight, Gamepad2, Clock, Trophy, RefreshCcw, Brain 
      } from 'lucide-react';
      import { 
        DndContext, DragOverlay, useDraggable, useDroppable, 
        MouseSensor, TouchSensor, useSensor, useSensors 
      } from '@dnd-kit/core';

      // --- データベース ---
      const IDIOM_DATABASE = {
        elementary_low: [
          { answer: '一石二鳥', reading: 'いっせきにちょう', question: '一つのことをして、二つの利益を得ること。', explanation: '石を一つ投げて、二羽の鳥を仕留めるという意味から来ています。', distractors: ['三', '犬', '空', '大', '小', '早', '力', '山'] },
          { answer: '十人十色', reading: 'じゅうにんといろ', question: '人にはそれぞれ考えや好みがあること。', explanation: '十人いれば十通りの考えがあるという意味です。', distractors: ['百', '千', '赤', '青', '目', '耳', '鼻', '口'] },
          { answer: '三日坊主', reading: 'みっかぼうず', question: '飽きやすくて、物事が長続きしないこと。', explanation: '三日間だけお坊さんの修行をしてやめてしまうことから。', distractors: ['五', '七', '寺', '僧', '走', '歩', '寝', '食'] },
          { answer: '一生懸命', reading: 'いっしょうけんめい', question: '命をかけるほど、本気で物事に取り組むこと。', explanation: '昔は「一所懸命（一つの場所を守る）」と言っていました。', distractors: ['二', '死', '勝', '負', '走', '力', '心', '体'] },
          { answer: '右往左往', reading: 'うおうさおう', question: '混乱して、あっちへ行ったりこっちへ来たりすること。', explanation: '右に行ったり左に行ったりして、落ち着かない様子です。', distractors: ['上', '下', '北', '南', '中', '前', '後', '進'] },
        ],
        elementary_high: [
          { answer: '一喜一憂', reading: 'いっきいちゆう', question: '状況が変わるたびに、喜んだり不安になったりすること。', explanation: '「喜」はよろこび、「憂」は心配すること。', distractors: ['哀', '楽', '笑', '怒', '泣', '怖', '驚', '静'] },
          { answer: '異口同音', reading: 'いくどうおん', question: 'みんながそろって同じことを言うこと。', explanation: '異なる口から同じ音（言葉）が出るという意味です。', distractors: ['耳', '鼻', '同', '他', '多', '少', '大', '小'] },
          { answer: '自業自得', reading: 'じごうじとく', question: '自分の悪い行いの結果を、自分が受けること。', explanation: '自分の業（おこない）は自分に返ってくるという意味です。', distractors: ['他', '善', '悪', '罰', '天', '地', '神', '仏'] },
          { answer: '悪戦苦闘', reading: 'あくせんくとう', question: '苦しい状況の中で、一生懸命がんばること。', explanation: '悪い戦いと苦しい闘いという、非常に困難な様子です。', distractors: ['勝', '利', '強', '弱', '平', '和', '光', '影'] },
        ],
        junior_high: [
          { answer: '誠心誠意', reading: 'せいしんせいい', question: 'うそがなく、真心を持って人に接すること。', explanation: '「誠」も「意」も、偽りのない心を表します。', distractors: ['情', '報', '愛', '敬', '信', '義', '礼', '智'] },
          { answer: '試行錯誤', reading: 'しこうさくご', question: '失敗を繰り返しながら、正解に近づいていくこと。', explanation: '何度も試して（試行）、間違い（錯誤）を直していく様子です。', distractors: ['検', '査', '計', '算', '完', '了', '成', '功'] },
          { answer: '自画自賛', reading: 'じがじさん', question: '自分のしたことを自分でほめること。', explanation: '自分で描いた絵に、自分で褒め言葉を書くことから。', distractors: ['他', '人', '批', '判', '謙', '虚', '誇', '慢'] },
          { answer: '以心伝心', reading: 'いしんでんしん', question: '言葉を使わなくても、お互いの気持ちが通じ合うこと。', explanation: '心をもって心に伝えるという意味の仏教用語です。', distractors: ['目', '口', '話', '語', '聞', '聴', '感', '覚'] },
        ],
        high_school: [
          { answer: '臥薪嘗胆', reading: 'がしんしょうたん', question: '目的を果たすために、長い間苦労に耐えること。', explanation: '薪（まき）の上に寝て、苦い胆（きも）をなめるという中国の故事。', distractors: ['努', '力', '忍', '耐', '成', '功', '失', '敗'] },
          { answer: '傍若無人', reading: 'ぼうじゃくぶじん', question: '周りに人がいないかのように、勝手気ままにふるまうこと。', explanation: '「傍（かたわら）に人無きが若（ごと）し」と読みます。', distractors: ['丁', '寧', '親', '切', '傲', '慢', '礼', '儀'] },
          { answer: '竜頭蛇尾', reading: 'りゅうとうだび', question: '初めは勢いがいいが、終わりがふるわないこと。', explanation: '頭は立派な竜なのに、尻尾はヘビのように細い様子。', distractors: ['虎', '馬', '鳥', '魚', '終', '始', '完', '結'] },
          { answer: '呉越同舟', reading: 'ごえつどうしゅう', question: '仲の悪い者同士が、同じ場所にいたり協力したりすること。', explanation: '敵対する呉と越の国の人が同じ舟に乗るという意味です。', distractors: ['友', '敵', '海', '川', '波', '風', '山', '谷'] },
        ],
        adult: [
          { answer: '乾坤一擲', reading: 'けんこんいってき', question: '運命をかけて、のるかそるかの大勝負をすること。', explanation: '天（乾）と地（坤）をサイコロの一投げ（一擲）にかけること。', distractors: ['博', '打', '運', '勢', '勝', '負', '命', '運'] },
          { answer: '質実剛健', reading: 'しつじつごうけん', question: '飾り気がなく、真面目で、心身ともにたくましいこと。', explanation: '質朴で実直、強く健やかであることを言います。', distractors: ['華', '美', '柔', '軟', '清', '潔', '誠', '実'] },
          { answer: '唯我独尊', reading: 'ゆいがどくそん', question: '自分だけが優れていると思い上がること。（本来は尊い命の意味）', explanation: 'お釈迦様が生まれた時に言ったとされる言葉です。', distractors: ['謙', '遜', '仏', '教', '神', '聖', '平', '等'] },
          { answer: '温故知新', reading: 'おんこちしん', question: '昔の物事を研究して、そこから新しい知識や道理を得ること。', explanation: '古いものをたずねて新しいことを知る、という意味です。', distractors: ['古', '新', '研', '究', '学', '問', '習', '得'] },
        ]
      };

      const LEVELS = [
        { id: 'elementary_low', label: '小学生低学年', description: '基本中の基本！数字や簡単な漢字の四字熟語' },
        { id: 'elementary_high', label: '小学生高学年', description: '教科書に出てくる有名な四字熟語' },
        { id: 'junior_high', label: '中学生', description: '一般常識として知っておきたいレベル' },
        { id: 'high_school', label: '高校生', description: '入試や文学作品に出てくる表現' },
        { id: 'adult', label: '大人', description: '新聞やビジネスで使える高度な四字熟語' },
      ];

      // --- パーツコンポーネント ---
      const DraggableKanji = ({ id, char, isOverlay }) => {
        const { attributes, listeners, setNodeRef, isDragging } = useDraggable({ id });
        const baseStyle = "w-14 h-14 sm:w-16 sm:h-16 lg:w-20 lg:h-20 text-2xl sm:text-3xl lg:text-4xl bg-white border-b-4 border-r-4 border-2 border-japan-indigo rounded-lg flex items-center justify-center font-black text-japan-indigo select-none touch-manipulation";
        const style = isOverlay ? "z-50 scale-110 rotate-6 shadow-2xl border-pop-cyan text-pop-cyan" : isDragging ? "opacity-20 scale-90" : "cursor-grab hover:-translate-y-1 transition-all";
        return <div ref={setNodeRef} {...listeners} {...attributes} className={`${baseStyle} ${style}`}>{char}</div>;
      };

      const AnswerSlot = ({ id, children, isCorrect }) => {
        const { setNodeRef, isOver } = useDroppable({ id });
        const sizeClasses = "w-14 h-14 sm:w-16 sm:h-16 lg:w-20 lg:h-20";
        let borderColor = isCorrect === true ? "border-pop-green" : isCorrect === false ? "border-japan-red" : isOver ? "border-pop-cyan" : "border-japan-indigo/20";
        let bgColor = isCorrect === true ? "bg-pop-green/20" : isCorrect === false ? "bg-japan-red/20" : isOver ? "bg-pop-cyan/20" : "bg-japan-indigo/5";
        return <div ref={setNodeRef} className={`${sizeClasses} rounded-xl border-4 border-dashed flex items-center justify-center transition-colors ${borderColor} ${bgColor}`}>{children}</div>;
      };

      // --- 画面コンポーネント ---
      const StartScreen = ({ onStart }) => {
        const [time, setTime] = useState(20);
        return (
          <div className="flex flex-col items-center space-y-8 animate-bounce-in py-6">
            <h1 className="text-5xl md:text-7xl font-black text-japan-indigo text-center">四字熟語<br /><span className="text-transparent bg-clip-text bg-gradient-to-r from-pop-cyan to-pop-purple">マスター</span></h1>
            <div className="w-full bg-white border-4 border-japan-indigo p-5 rounded-3xl shadow-hard">
              <div className="flex items-center gap-2 mb-4 font-black"><Clock className="w-5 h-5 text-pop-purple" />制限時間</div>
              <div className="grid grid-cols-4 gap-2">
                {[10, 20, 30, 0].map(t => <button key={t} onClick={() => setTime(t)} className={`py-2 rounded-xl font-black border-2 border-japan-indigo ${time === t ? 'bg-pop-purple text-white' : 'bg-gray-50 text-gray-400'}`}>{t || 'なし'}{t ? '秒' : ''}</button>)}
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 w-full">
              {LEVELS.map((l, i) => (
                <button key={l.id} onClick={() => onStart(l.id, time)} className={`p-5 rounded-2xl bg-white border-4 border-japan-indigo text-left shadow-hard hover:-translate-y-1 transition-all ${i === LEVELS.length-1 ? 'md:col-span-2' : ''}`}>
                  <div className="font-black text-xl">{l.label}</div>
                  <p className="text-xs font-bold text-gray-400 mt-1">{l.description}</p>
                </button>
              ))}
            </div>
          </div>
        );
      };

      const QuizScreen = ({ questions, timeLimit, onFinish }) => {
        const [idx, setIdx] = useState(0);
        const [score, setScore] = useState(0);
        const [items, setItems] = useState([]);
        const [slots, setSlots] = useState([null, null, null, null]);
        const [status, setStatus] = useState('unanswered');
        const [activeId, setActiveId] = useState(null);
        const [timeLeft, setTimeLeft] = useState(timeLimit);
        const sensors = useSensors(useSensor(MouseSensor), useSensor(TouchSensor, { activationConstraint: { delay: 0, tolerance: 5 } }));
        const q = questions[idx];

        useEffect(() => {
          if (!q) return;
          const all = [...q.answer.split('').map((c, i) => ({ id: `a-${idx}-${i}-${c}`, char: c })), ...q.distractors.slice(0, 4).map((c, i) => ({ id: `d-${idx}-${i}-${c}`, char: c }))].sort(() => Math.random() - 0.5);
          setItems(all); setSlots([null, null, null, null]); setStatus('unanswered'); setTimeLeft(timeLimit);
        }, [idx, q, timeLimit]);

        useEffect(() => {
          if (timeLimit > 0 && status === 'unanswered' && timeLeft > 0) {
            const t = setInterval(() => setTimeLeft(p => p - 0.1), 100);
            return () => clearInterval(t);
          }
        }, [timeLeft, status, timeLimit]);

        if (timeLimit > 0 && timeLeft <= 0 && status === 'unanswered') setStatus('wrong');

        const handleDragEnd = (e) => {
          setActiveId(null);
          if (!e.over || status !== 'unanswered') return;
          const tid = e.over.id;
          const sid = slots.findIndex(s => s === e.active.id);
          const next = [...slots];
          if (tid === 'pool') { if (sid !== -1) next[sid] = null; }
          else if (tid.startsWith('slot-')) {
            const targetIdx = parseInt(tid.split('-')[1]);
            if (sid !== -1) next[sid] = slots[targetIdx];
            next[targetIdx] = e.active.id;
          }
          setSlots(next);
        };

        const check = () => {
          const ans = slots.map(id => items.find(it => it.id === id)?.char || '').join('');
          if (ans === q.answer) { setStatus('correct'); setScore(s => s + 1); } else { setStatus('wrong'); }
        };

        return (
          <DndContext sensors={sensors} onDragStart={e => setActiveId(e.active.id)} onDragEnd={handleDragEnd}>
            <div className="w-full flex flex-col lg:flex-row gap-8 animate-fade-in min-h-[500px]">
              <div className="lg:w-1/2 space-y-4">
                <div className="flex justify-between font-black"><span className="bg-japan-indigo text-white px-3 py-1 rounded-full text-sm">Q.{idx+1}/{questions.length}</span><div className="bg-white px-3 py-1 rounded-full border-2 border-japan-indigo flex items-center gap-2"><Trophy className="w-4 h-4 text-pop-yellow fill-current" />{score}PT</div></div>
                <div className="bg-japan-indigo rounded-3xl p-8 border-4 border-japan-indigo shadow-hard text-white text-center h-48 lg:h-64 flex flex-col justify-center relative overflow-hidden">
                  <h2 className="text-2xl md:text-3xl font-black">{q.question}</h2>
                  {timeLimit > 0 && status === 'unanswered' && <div className="mt-4 font-black text-pop-cyan">{Math.max(0, timeLeft).toFixed(1)}s</div>}
                </div>
              </div>
              <div className="lg:w-1/2 flex flex-col items-center gap-6">
                <div className="flex gap-2">{slots.map((id, i) => <AnswerSlot key={i} id={`slot-${i}`} isCorrect={status === 'unanswered' ? null : status === 'correct'}>{id && <DraggableKanji id={id} char={items.find(it => it.id === id).char} />}</AnswerSlot>)}</div>
                <div className="h-12">
                  {status === 'unanswered' ? (slots.every(s => s) && <button onClick={check} className="bg-pop-cyan border-4 border-japan-indigo px-8 py-2 rounded-xl font-black shadow-hard-sm">決定！</button>) : (
                    <div className="flex gap-4"><div className={`px-6 py-2 rounded-xl font-black border-4 border-japan-indigo ${status === 'correct' ? 'bg-pop-green' : 'bg-japan-red text-white'}`}>{status === 'correct' ? '正解！' : '残念...'}</div><button onClick={() => idx < questions.length - 1 ? setIdx(p => p + 1) : onFinish(score)} className="bg-japan-indigo text-white px-6 py-2 rounded-xl font-black flex items-center gap-2">{idx < questions.length - 1 ? '次へ' : '結果発表'} <ChevronRight className="w-4 h-4" /></button></div>
                  )}
                </div>
                <div className="w-full bg-white border-4 border-dashed border-gray-200 rounded-3xl p-6 min-h-[200px] flex justify-center items-center">
                  {status === 'unanswered' ? <div className="grid grid-cols-4 gap-4">{items.filter(it => !slots.includes(it.id)).map(it => <DraggableKanji key={it.id} id={it.id} char={it.char} />)}</div> : (
                    <div className="text-center"><div className="text-4xl font-black text-japan-indigo tracking-widest">{q.answer}</div><div className="text-pop-purple font-bold">{q.reading}</div><p className="mt-2 text-xs font-bold text-gray-500">{q.explanation}</p></div>
                  )}
                </div>
              </div>
            </div>
            <DragOverlay className="drag-overlay-card">{activeId ? <DraggableKanji id={activeId} char={items.find(i => i.id === activeId).char} isOverlay /> : null}</DragOverlay>
          </DndContext>
        );
      };

      const ResultScreen = ({ score, total, questions, onRestart }) => (
        <div className="w-full max-w-2xl mx-auto animate-bounce-in space-y-8 pb-10">
          <div className="bg-japan-indigo rounded-3xl p-8 text-center border-4 border-japan-indigo shadow-hard text-white">
            <Trophy className="w-12 h-12 fill-pop-yellow text-japan-indigo mx-auto mb-4 bg-white p-2 rounded-full" />
            <h2 className="text-4xl font-black italic mb-6">RESULT</h2>
            <div className="flex justify-center gap-10 mb-8"><div className="text-center"><p className="text-xs font-bold text-gray-400">SCORE</p><p className="text-5xl font-black">{score}/{total}</p></div></div>
            <button onClick={onRestart} className="bg-pop-cyan text-japan-indigo px-10 py-3 rounded-xl font-black text-lg border-b-4 border-r-4 border-white shadow-hard flex items-center gap-2 mx-auto"><RefreshCcw className="w-5 h-5" /> REPLAY</button>
          </div>
          <div className="space-y-3">{questions.map((q, i) => <div key={i} className="bg-white p-4 rounded-xl border-2 border-japan-indigo shadow-hard-sm flex gap-4"><span className="w-8 h-8 rounded bg-japan-indigo text-white flex items-center justify-center font-black">{i+1}</span><div><p className="text-xl font-black">{q.answer} <span className="text-sm font-bold text-pop-purple ml-2">{q.reading}</span></p><p className="text-xs font-bold text-gray-500">{q.explanation}</p></div></div>)}</div>
        </div>
      );

      // --- メインアプリ ---
      const App = () => {
        const [state, setState] = useState('START');
        const [questions, setQuestions] = useState([]);
        const [score, setScore] = useState(0);
        const [time, setTime] = useState(20);

        const start = (levelId, limit) => {
          setState('LOADING'); setTime(limit);
          setTimeout(() => {
            const q = [...IDIOM_DATABASE[levelId]].sort(() => Math.random() - 0.5).slice(0, 5);
            setQuestions(q); setState('QUIZ'); setScore(0);
          }, 1000);
        };

        return (
          <div className="min-h-screen flex flex-col items-center p-4 w-full">
            <header className="w-full max-w-5xl mx-auto p-4 flex justify-between items-center z-10">
              <div onClick={() => setState('START')} className="flex items-center gap-2 text-japan-indigo cursor-pointer bg-white px-4 py-2 rounded-full border-2 border-japan-indigo shadow-hard-sm">
                <div className="bg-pop-cyan p-1 rounded-full text-white"><Zap className="w-4 h-4 fill-current" /></div>
                <span className="font-black text-sm tracking-tighter">YOJI-MASTER</span>
              </div>
            </header>
            <main className="w-full max-w-5xl mx-auto flex-grow flex flex-col justify-center">
              {state === 'START' && <StartScreen onStart={start} />}
              {state === 'LOADING' && <div className="text-center animate-fade-in"><div className="bg-white p-8 rounded-2xl border-4 border-japan-indigo shadow-hard animate-bounce mb-6 inline-block"><Brain className="w-12 h-12" /></div><p className="font-black text-japan-indigo text-xl">問題を準備中...</p></div>}
              {state === 'QUIZ' && <QuizScreen questions={questions} timeLimit={time} onFinish={s => { setScore(s); setState('RESULT'); }} />}
              {state === 'RESULT' && <ResultScreen score={score} total={questions.length} questions={questions} onRestart={() => setState('START')} />}
            </main>
            <footer className="mt-8 mb-4 text-[10px] font-bold text-gray-400 text-center uppercase tracking-widest opacity-50">Standalone Quiz Engine</footer>
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
