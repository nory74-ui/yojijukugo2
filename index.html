<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>四字熟語マスター</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['"Zen Maru Gothic"', 'sans-serif'] },
            colors: {
              'japan-red': '#ff4057', 'japan-indigo': '#1e293b', 'pop-cyan': '#22d3ee',
              'pop-yellow': '#facc15', 'pop-purple': '#a855f7', 'pop-green': '#4ade80',
            },
            boxShadow: {
              'hard': '4px 4px 0px 0px #1e293b',
              'hard-sm': '2px 2px 0px 0px #1e293b',
              'hard-lg': '8px 8px 0px 0px #1e293b',
            },
            animation: {
              'bounce-in': 'bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
              'fade-in': 'fadeIn 0.3s ease-out forwards',
            },
            keyframes: {
              bounceIn: { '0%': { transform: 'scale(0.8)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
            }
          },
        },
      }
    </script>
    <style>
      body {
        background-color: #f1f5f9;
        color: #1e293b;
        background-image: radial-gradient(#cbd5e1 2px, transparent 2px);
        background-size: 24px 24px;
        overscroll-behavior-y: none;
        -webkit-tap-highlight-color: transparent;
      }
      #root { min-height: 100vh; display: flex; flex-direction: column; }
      .drag-overlay-card { z-index: 9999 !important; pointer-events: none; }
    </style>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.0.0",
        "react-dom": "https://esm.sh/react-dom@19.0.0",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.463.0?external=react",
        "@dnd-kit/core": "https://esm.sh/@dnd-kit/core@6.1.0?external=react,react-dom",
        "@dnd-kit/utilities": "https://esm.sh/@dnd-kit/utilities@3.2.2?external=react,react-dom"
      }
    }
    </script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect } from 'react';
      import ReactDOM from 'react-dom/client';
      import { 
        Zap, Star, ChevronRight, Gamepad2, Clock, Trophy, RefreshCcw, Brain 
      } from 'lucide-react';
      import { 
        DndContext, DragOverlay, useDraggable, useDroppable, 
        MouseSensor, TouchSensor, useSensor, useSensors 
      } from '@dnd-kit/core';

      // --- データベース (計100問・すべて1文字カード) ---
      const IDIOM_DATABASE = {
        elementary_low: [
          { answer: '一石二鳥', reading: 'いっせきにちょう', question: '一つのことをして、二つの利益を得ること。', explanation: '石を一つ投げて、二羽の鳥を仕留めるという意味。', distractors: ['三', '犬', '空', '大', '小', '早', '力', '山'] },
          { answer: '十人十色', reading: 'じゅうにんといろ', question: '人にはそれぞれ考えや好みがあること。', explanation: '十人いれば十通りの考えがあるという意味。', distractors: ['百', '千', '赤', '青', '目', '耳', '鼻', '口'] },
          { answer: '三日坊主', reading: 'みっかぼうず', question: '飽きやすくて、物事が長続きしないこと。', explanation: '三日間だけ修行をしてやめてしまうことから。', distractors: ['五', '七', '寺', '僧', '走', '歩', '寝', '食'] },
          { answer: '一生懸命', reading: 'いっしょうけんめい', question: '命をかけるほど、本気で取り組むこと。', explanation: '昔は「一所懸命（一つの場所を守る）」と言いました。', distractors: ['二', '死', '勝', '負', '走', '力', '心', '体'] },
          { answer: '右往左往', reading: 'うおうさおう', question: '混乱して、あっちへ行ったりこっちへ来たりすること。', explanation: '右に行ったり左に行ったりして落ち着かない様子。', distractors: ['上', '下', '北', '南', '中', '前', '後', '進'] },
          { answer: '七転八起', reading: 'ななころびやおき', question: '何度失敗しても、あきらめずに立ち上がること。', explanation: '七回転んでも八回起き上がる、という意味。', distractors: ['六', '九', '零', '数', '転', '倒', '勝', '負'] },
          { answer: '四面楚歌', reading: 'しめんそか', question: '周りがすべて敵ばかりで、助けがないこと。', explanation: '四方の壁から敵の歌が聞こえてきたという故事から。', distractors: ['三', '五', '歌', '音', '敵', '味', '方', '城'] },
          { answer: '千差万別', reading: 'せんさばんべつ', question: '種類や様子が、さまざまに異なっていること。', explanation: '千も万も違いがあるという意味。', distractors: ['百', '億', '色', '形', '同', '様', '変', '化'] },
          { answer: '馬耳東風', reading: 'ばじとうふう', question: '人の意見を聞き流して、少しも気にかけないこと。', explanation: '馬の耳に春風が吹いても何も感じないことから。', distractors: ['牛', '耳', '西', '南', '聞', '話', '風', '空'] },
          { answer: '弱肉強食', reading: 'じゃくにくきょうしょく', question: '強い者が弱い者をえじきにして栄えること。', explanation: '自然界の厳しい生存競争を表す言葉。', distractors: ['強', '弱', '勝', '負', '食', '飲', '生', '死'] },
          { answer: '一朝一夕', reading: 'いっちょういっせき', question: 'わずかな時間。短い期間。', explanation: '一日の朝と一日の夕方。非常に短い時間のたとえ。', distractors: ['長', '月', '年', '代', '秒', '分', '早', '遅'] },
          { answer: '自問自答', reading: 'じもんじとう', question: '自分で問い、自分で答えること。', explanation: '心の中で悩み、一人で考える様子。', distractors: ['他', '外', '聞', '話', '聴', '説', '言', '語'] },
          { answer: '大安吉日', reading: 'たいあんきちじつ', question: '万事に良いとされる、とても縁起の良い日。', explanation: 'カレンダーの六曜の中で最も良い日。', distractors: ['不', '滅', '負', '勝', '友', '引', '仏', '引'] },
          { answer: '喜怒哀楽', reading: 'きどあいらく', question: '人間が持つ様々な感情のこと。', explanation: '喜び、怒り、悲しみ、楽しみの四つ。', distractors: ['愛', '憎', '恋', '欲', '心', '情', '感', '覚'] },
          { answer: '古今東西', reading: 'ここんとうざい', question: '昔から今、東から西まで。あらゆる時と場所。', explanation: 'いつでも、どこでも、という意味。', distractors: ['北', '南', '中', '外', '新', '旧', '代', '世'] },
          { answer: '公明正大', reading: 'こうめいせいだい', question: 'やましいところがなく、正しく堂々としていること。', explanation: '公平で正しい様子を表します。', distractors: ['私', '隠', '闇', '裏', '細', '小', '狭', '弱'] },
          { answer: '朝令暮改', reading: 'ちょうれいぼかい', question: '命令が次々と変わり、あてにならないこと。', explanation: '朝に出した命令を夕方には変えてしまうこと。', distractors: ['昼', '夜', '昼', '間', '定', '守', '信', '頼'] },
          { answer: '無我夢中', reading: 'むがむちゅう', question: '自分を忘れるほど、物事に熱中すること。', explanation: '心が奪われて、周りが見えない状態。', distractors: ['有', '実', '覚', '醒', '醒', '静', '止', '考'] },
          { answer: '立身出世', reading: 'りっしんしゅっせ', question: '社会的に高い地位につき、有名になること。', explanation: '成功して認められること。', distractors: ['没', '落', '貧', '困', '安', '泰', '平', '凡'] },
          { answer: '十全十美', reading: 'じゅうぜんじゅうび', question: '全く欠点がなく、完璧であること。', explanation: 'すべてが整い、美しい様子。', distractors: ['九', '八', '不', '満', '足', '欠', '損', '低'] }
        ],
        elementary_high: [
          { answer: '一喜一憂', reading: 'いっきいちゆう', question: '状況が変わるたびに、喜んだり不安になったりすること。', explanation: '「喜」はよろこび、「憂」は心配すること。', distractors: ['哀', '楽', '笑', '怒', '泣', '怖', '驚', '静'] },
          { answer: '異口同音', reading: 'いくどうおん', question: 'みんながそろって同じことを言うこと。', explanation: '異なる口から同じ音（言葉）が出るという意味。', distractors: ['耳', '鼻', '同', '他', '多', '少', '大', '小'] },
          { answer: '自業自得', reading: 'じごうじとく', question: '自分の悪い行いの結果を、自分が受けること。', explanation: '自分の業は自分に返ってくるという意味。', distractors: ['他', '善', '悪', '罰', '天', '地', '神', '仏'] },
          { answer: '悪戦苦闘', reading: 'あくせんくとう', question: '苦しい状況の中で、一生懸命がんばること。', explanation: '悪い戦いと苦しい闘いという困難な様子。', distractors: ['勝', '利', '強', '弱', '平', '和', '光', '影'] },
          { answer: '意気投合', reading: 'いきとうごう', question: 'お互いの気持ちや考えがぴったり合うこと。', explanation: '気持ちが投げ合って合うという意味。', distractors: ['心', '感', '信', '友', '結', '離', '通', '解'] },
          { answer: '暗中模索', reading: 'あんちゅうもさく', question: '手がかりがない中で、いろいろ試してみること。', explanation: '暗闇の中で手探りで探し求めるという意味。', distractors: ['光', '明', '探', '究', '道', '標', '見', '失'] },
          { answer: '以心伝心', reading: 'いしんでんしん', question: '言葉を使わなくても気持ちが通じ合うこと。', explanation: '心から心へ伝えるという意味の仏教用語。', distractors: ['話', '語', '聞', '耳', '目', '通', '知', '覚'] },
          { answer: '絶体絶命', reading: 'ぜったいぜつめい', question: 'どうにも逃げられない、追い詰められた状態。', explanation: '命が絶えるような、極限のピンチ。', distractors: ['危', '険', '死', '活', '逃', '追', '窮', '地'] },
          { answer: '文武両道', reading: 'ぶんぶりょうどう', question: '勉強とスポーツの両方に優れていること。', explanation: '文（学問）と武（武道）の両方の道。', distractors: ['学', '体', '技', '術', '全', '能', '才', '華'] },
          { answer: '油断大敵', reading: 'ゆだんたいてき', question: '少しでも怠れば、大きな失敗を招くということ。', explanation: '油断こそが最も恐しい敵という意味。', distractors: ['不', '注', '意', '心', '隙', '守', '攻', '敗'] },
          { answer: '猪突猛進', reading: 'ちょとつもうしん', question: '目標に向かって、向こう見ずに突き進むこと。', explanation: 'イノシシが一直線に走る様子から。', distractors: ['慎', '重', '考', '慮', '後', '退', '静', '止'] },
          { answer: '温故知新', reading: 'おんこちしん', question: '昔の事を研究して、新しい知識を得ること。', explanation: '古いものをたずねて新しいことを知る。', distractors: ['新', '鮮', '研', '究', '学', '問', '未', '来'] },
          { answer: '単刀直入', reading: 'たんとうちょくにゅう', question: '前置きなしに、いきなり本題に入ること。', explanation: '一人で刀を持って敵陣に切り込むことから。', distractors: ['遠', '慮', '婉', '曲', '周', '到', '準', '備'] },
          { answer: '適材適所', reading: 'てきざいてきしょ', question: '能力に合った役目を与えること。', explanation: 'ふさわしい材料をふさわしい場所へ。', distractors: ['人', '物', '配', '置', '能', '力', '選', '定'] },
          { answer: '本末転倒', reading: 'ほんまつてんとう', question: '大事なことと、つまらないことを取り違えること。', explanation: '根本と末節を逆にしてしまうこと。', distractors: ['正', '常', '順', '序', '重', '要', '基', '本'] },
          { answer: '試行錯誤', reading: 'しこうさくご', question: '失敗を繰り返しながら、正解に近づくこと。', explanation: '何度も試して間違いを直していく。', distractors: ['完', '了', '一', '発', '成', '功', '即', '答'] },
          { answer: '四通八達', reading: 'しつうはったつ', question: '道路や通信網が四方八方に通じていること。', explanation: '交通が非常に便利な様子。', distractors: ['渋', '滞', '遮', '断', '閉', '鎖', '一', '方'] },
          { answer: '前代未聞', reading: 'ぜんだいみもん', question: 'これまで一度も聞いたことがないような珍しいこと。', explanation: '歴史上、例がないほど驚くべきこと。', distractors: ['有', '名', '通', '常', '平', '凡', '毎', '度'] },
          { answer: '有名無実', reading: 'ゆうめいむじつ', question: '名前ばかり立派で、中身が伴っていないこと。', explanation: '評判は高いが実際はダメなこと。', distractors: ['質', '実', '剛', '健', '誠', '実', '本', '物'] },
          { answer: '取捨選択', reading: 'しゅしゃせんたく', question: '良いものを選び取り、悪いものを捨てること。', explanation: '必要なものだけをピックアップすること。', distractors: ['全', '部', '保', '持', '混', '乱', '放', '置'] }
        ],
        junior_high: [
          { answer: '誠心誠意', reading: 'せいしんせいい', question: '真心を持って人に接すること。', explanation: 'うそがなく、一生懸命な心。', distractors: ['偽', '善', '商', '売', '愛', '敬', '信', '頼'] },
          { answer: '意味深長', reading: 'いみしんちょう', question: '言葉の裏に深い意味が含まれていること。', explanation: '含みのある言い方のこと。', distractors: ['単', '純', '明', '白', '浅', '短', '理', '解'] },
          { answer: '支離滅裂', reading: 'しりめつれつ', question: 'まとまりがなく、バラバラでわけがわからないこと。', explanation: '話のつじつまが合わない様子。', distractors: ['整', '然', '一', '貫', '論', '理', '明', '快'] },
          { answer: '切磋琢磨', reading: 'せっさたくま', question: '仲間同士で励まし合い、向上すること。', explanation: '自分を磨き上げるという意味。', distractors: ['怠', '慢', '孤', '立', '競', '争', '喧', '嘩'] },
          { answer: '波瀾万丈', reading: 'はらんばんじょう', question: '変化が激しく、出来事が非常に多いこと。', explanation: 'ドラマチックな人生のたとえ。', distractors: ['平', '穏', '安', '泰', '退', '屈', '単', '調'] },
          { answer: '悠々自適', reading: 'ゆうゆうじてき', question: 'のんびりと自分の思うままに暮らすこと。', explanation: '世間に縛られない生活。', distractors: ['多', '忙', '束', '縛', '窮', '屈', '焦', '燥'] },
          { answer: '危機一髪', reading: 'ききいっぱつ', question: '非常に危険な、ぎりぎりの状態。', explanation: '髪の毛一本ほどの差で助かる様子。', distractors: ['安', '全', '余', '裕', '勝', '利', '決', '定'] },
          { answer: '起死回生', reading: 'きしかいせい', question: '絶望的な状態から、一気に持ち直すこと。', explanation: '死にそうな状態から生き返ること。', distractors: ['絶', '望', '敗', '北', '没', '落', '終', '了'] },
          { answer: '五里霧中', reading: 'ごりむちゅう', question: '手がかりがなく、どうしていいか迷うこと。', explanation: '深い霧の中で方向を失うこと。', distractors: ['明', '白', '発', '見', '解', '決', '光', '明'] },
          { answer: '言行一致', reading: 'げんこういっち', question: '言うことと、することと同じであること。', explanation: '口先だけでなく実行すること。', distractors: ['矛', '盾', '反', '対', '嘘', '偽', '裏', '切'] },
          { answer: '三位一体', reading: 'さんみいったい', question: '三つのものが一つに組み合わさること。', explanation: 'バラバラなものが協力して一つになる。', distractors: ['分', '離', '分', '裂', '対', '立', '個', '別'] },
          { answer: '主客転倒', reading: 'しゅかくてんとう', question: '立場や重要度が逆転してしまうこと。', explanation: '主人と客が入れ替わるという意味。', distractors: ['正', '常', '順', '位', '本', '来', '当', '然'] },
          { answer: '諸行無常', reading: 'しょぎょうむじょう', question: '世の中のすべてのものは、絶えず変化すること。', explanation: '永遠に変わらないものはない。', distractors: ['永', '遠', '不', '変', '固', '定', '恒', '久'] },
          { answer: '針小棒大', reading: 'しんしょうぼうだい', question: 'ささいなことを、大げさに言うこと。', explanation: '針ほどのことを棒ほどに言う。', distractors: ['事', '実', '正', '確', '過', '小', '微', '細'] },
          { answer: '画龍点睛', reading: 'がりょうてんせい', question: '物事を完成させるための、最後の仕上げ。', explanation: '龍の絵に目を描き入れること。', distractors: ['失', '敗', '中', '途', '未', '完', '略', '式'] },
          { answer: '勧善懲悪', reading: 'かんぜんちょうあく', question: '善いことを奨励し、悪いことを懲らしめること。', explanation: '正義が勝つストーリー。', distractors: ['不', '義', '闇', '堕', '悪', '魔', '混', '沌'] },
          { answer: '疑心暗鬼', reading: 'ぎしんあんき', question: '疑い出すと、何でもないことまで怖くなること。', explanation: '疑いの心が幽霊を生む。', distractors: ['信', '頼', '確', '信', '安', '心', '平', '和'] },
          { answer: '順風満帆', reading: 'じゅんぷうまんぱん', question: '物事が非常に順調に進むこと。', explanation: '追い風を受けて帆を張る様子。', distractors: ['逆', '境', '苦', '難', '停', '滞', '荒', '波'] },
          { answer: '晴天霹靂', reading: 'せいてんのへきれき', question: '突然起こる、予想外の大きな出来事。', explanation: '青空に急に雷が鳴ること。', distractors: ['予', '定', '当', '然', '必', '然', '穏', '和'] },
          { answer: '正々堂々', reading: 'せいせいどうどう', question: '卑怯なことをせず、真っ向から勝負すること。', explanation: '態度が立派で正しい様子。', distractors: ['卑', '怯', '陰', '湿', '裏', '道', '不', '正'] }
        ],
        high_school: [
          { answer: '臥薪嘗胆', reading: 'がしんしょうたん', question: '復讐や目的達成のために、苦労に耐えること。', explanation: '薪の上で寝て苦い胆をなめる故事。', distractors: ['成', '功', '安', '穏', '妥', '協', '幸', '福'] },
          { answer: '竜頭蛇尾', reading: 'りゅうとうだび', question: '初めは勢いが良いが、終わりがダメなこと。', explanation: '竜の頭に蛇の尻尾。', distractors: ['徹', '頭', '徹', '尾', '完', '璧', '有', '終'] },
          { answer: '呉越同舟', reading: 'ごえつどうしゅう', question: '敵同士が同じ場所にいたり、協力したりすること。', explanation: '仲の悪い者同士が同じ舟に乗る。', distractors: ['親', '密', '協', '力', '対', '立', '分', '離'] },
          { answer: '換骨奪胎', reading: 'かんこつだったい', question: '既存のものに独自の工夫を加え、新しくすること。', explanation: '骨を替え、胎を奪い取るという意。', distractors: ['模', '倣', '盗', '作', '剽', '窃', '完', '全'] },
          { answer: '雲散霧消', reading: 'うんさんむしょう', question: 'あとかたもなく、きれいに消えてなくなること。', explanation: '雲が散り霧が消える。', distractors: ['残', '留', '固', '定', '定', '着', '不', '変'] },
          { answer: '紆余曲折', reading: 'うよきょくせつ', question: '事情が複雑で、解決まで手間取ること。', explanation: '道が曲がりくねっていること。', distractors: ['一', '直', '線', '単', '純', '明', '快', '即', '決'] },
          { answer: '朝三暮四', reading: 'ちょうさんぼし', question: '目先の違いにこだわり、本質が見えないこと。', explanation: 'サルのエサの数の故事。', distractors: ['賢', '明', '洞', '察', '深', '慮', '真', '実'] },
          { answer: '隔靴掻痒', reading: 'かっかそうよう', question: 'もどかしくて、物足りない感じ。', explanation: '靴の上からかゆい所をかく。', distractors: ['満', '足', '快', '適', '痛', '快', '納', '得'] },
          { answer: '感慨無量', reading: 'かんがいむりょう', question: 'はかりしれないほど、深く心に感じること。', explanation: '思いが深く溢れること。', distractors: ['無', '感', '無', '関', '心', '冷', '淡', '浅'] },
          { answer: '急転直下', reading: 'きゅうてんちょっか', question: '事態が急に変わり、一気に解決に向かうこと。', explanation: '急に転じて真っ逆さまに落ちる。', distractors: ['停', '滞', '緩', '慢', '膠', '着', '難', '航'] },
          { answer: '驚天動地', reading: 'きょうてんどうち', question: '世間をひどく驚かせるような大事件。', explanation: '天を驚かせ地を動かす。', distractors: ['平', '穏', '日', '常', '些', '細', '静', '寂'] },
          { answer: '孤立無援', reading: 'こりつむえん', question: '誰の助けもなく、一人ぼっちでいること。', explanation: '周りに味方がいない状態。', distractors: ['協', '力', '団', '結', '支', '援', '大', '勢'] },
          { answer: '言語道断', reading: 'ごんご道断', reading: 'ごんごどうだん', question: '言葉で言い表せないほど、ひどいこと。', explanation: 'あきれて物も言えない。', distractors: ['称', '賛', '当', '然', '理', '解', '納', '得'] },
          { answer: '才色兼備', reading: 'さいしょくけんび', question: 'すぐれた才能と、美しい容姿の両方を持つこと。', explanation: '天は二物を与えた、のたとえ。', distractors: ['平', '凡', '無', '能', '醜', '悪', '一', '芸'] },
          { answer: '山紫水明', reading: 'さんしすいめい', question: '自然の風景が、清らかで美しいこと。', explanation: '山は紫、水は澄んでいる。', distractors: ['汚', '染', '荒', '廃', '都', '市', '雑', '踏'] },
          { answer: '首尾一貫', reading: 'しゅびいっかん', question: '最初から最後まで、方針が変わらないこと。', explanation: '頭と尻尾を貫くこと。', distractors: ['矛', '盾', '変', '節', '支', '離', '滅', '裂'] },
          { answer: '百戦錬磨', reading: 'ひゃくせんれんま', question: '多くの経験を積み、鍛えられていること。', explanation: '百回の戦いで磨かれる。', distractors: ['新', '人', '未', '熟', '初', '心', '素', '人'] },
          { answer: '粉骨砕身', reading: 'ふんこつさいしん', question: '骨を粉にし身を砕くほど、力の限り尽くすこと。', explanation: '一生懸命努力すること。', distractors: ['怠', '惰', '安', '逸', '手', '抜', '無', '理'] },
          { answer: '不言実行', reading: 'ふげんじっこう', question: 'あれこれ言わず、黙ってなすべきことをすること。', explanation: '有言実行の反対。', distractors: ['饒', '舌', '空', '論', '弁', '解', '有', '言'] },
          { answer: '傍若無人', reading: 'ぼうじゃくぶじん', question: '勝手気ままにふるまうこと。', explanation: '傍らに人がいないかのよう。', distractors: ['謙', '虚', '慎', 'み', '礼', '儀', '配', '慮'] }
        ],
        adult: [
          { answer: '乾坤一擲', reading: 'けんこんいってき', question: '運命をかけて、大勝負をすること。', explanation: '天地を一投げにかける。', distractors: ['堅', '実', '安', '全', '臆', '病', '消', '極'] },
          { answer: '質実剛健', reading: 'しつじつごうけん', question: '飾り気がなく、真面目で、たくましいこと。', explanation: '中身が詰まっていて強い。', distractors: ['華', '美', '軟', '弱', '軽', '薄', '派', '手'] },
          { answer: '唯我独尊', reading: 'ゆいがどくそん', question: '自分だけが尊いと思い上がること。', explanation: 'お釈迦様の言葉とされる。', distractors: ['謙', '遜', '卑', '下', '奉', '仕', '平', '等'] },
          { answer: '花鳥風月', reading: 'かちょうふうげつ', question: '自然の美しい風景。それを愛でる風流。', explanation: '日本の美の象徴。', distractors: ['殺', '風', '景', '俗', '世', '実', '利'] },
          { answer: '厚顔無恥', reading: 'こうがんむち', question: '厚かましくて、恥を知らないこと。', explanation: '面の皮が厚いこと。', distractors: ['謙', '虚', '慎', '重', '礼', '儀', '知', '性'] },
          { answer: '天衣無縫', reading: 'てんいむほう', question: '細工のあとがなく、自然で美しいこと。', explanation: '天人の衣には縫い目がない。', distractors: ['作', '為', '不', '自', '然', '不', '器', '用'] },
          { answer: '南船北馬', reading: 'なんせんほくば', question: '各地を絶えず忙しく旅すること。', explanation: '南は舟、北は馬。', distractors: ['定', '住', '安', '置', '一', '所', '閉', '居'] },
          { answer: '明鏡止水', reading: 'めいきょうしすい', question: '澄み切って落ち着いた心の状態。', explanation: '曇りのない鏡と静止した水。', distractors: ['混', '乱', '煩', '悩', '情', '熱', '殺', '気'] },
          { answer: '泰然自若', reading: 'たいぜんじじゃく', question: '落ち着いていて、動じない様子。', explanation: 'ゆったりと自分を保つ。', distractors: ['狼', '狽', '戦', '慄', '慌', '張', '臆', '病'] },
          { answer: '孤軍奮闘', reading: 'こぐんふんとう', question: '助けがない中で、一人で懸命に戦うこと。', explanation: '一人でがんばること。', distractors: ['協', '力', '共', '闘', '加', '勢', '大', '軍'] },
          { answer: '一騎当千', reading: 'いっきとうせん', question: '一人で千人の敵に対抗できるほど強いこと。', explanation: '人並み外れた能力。', distractors: ['弱', '小', '無', '力', '平', '凡', '凡', '才'] },
          { answer: '栄枯盛衰', reading: 'えいこせいすい', question: '盛んな時と衰える時があること。', explanation: '世の中の移り変わり。', distractors: ['不', '老', '長', '生', '恒', '久', '安', '泰'] },
          { answer: '夏炉冬扇', reading: 'かろとうせん', question: '時期外れで役に立たないもののたとえ。', explanation: '夏の暖炉、冬の扇。', distractors: ['重', '宝', '必', '需', '有', '用', '適', '時'] },
          { answer: '侃侃諤諤', reading: 'かんかんがくがく', question: '正論を堂々と述べ、盛んに議論すること。', explanation: 'ひるまずに主張する。', distractors: ['沈', '黙', '同', '調', '忖', '度', '逃', '避'] },
          { answer: '牛飲馬食', reading: 'ぎゅういんばしょく', question: 'たくさん飲んだり食べたりすること。', explanation: '大食らいのたとえ。', distractors: ['小', '食', '断', '食', '節', '制', '粗', '食'] },
          { answer: '九死一生', reading: 'きゅうしいっしょう', question: 'ほとんど助かる見込みがない中で、命を拾うこと。', explanation: '九分死んで一分生きる。', distractors: ['安', '泰', '当', '然', '即', '死', '全', '滅'] },
          { answer: '玉石混交', reading: 'ぎょくせきこんこう', question: '優れたものと劣ったものが混じっていること。', explanation: '宝石と石ころ。', distractors: ['洗', '練', '純', '粋', '厳', '選', '統', '一'] },
          { answer: '虚心坦懐', reading: 'きょしんたんかい', question: '先入観を持たず、素直な心で接すること。', explanation: 'わだかまりのない心。', distractors: ['偏', '見', '邪', '念', '下', '心', '執', '着'] },
          { answer: '謹厳実直', reading: 'きんげんじっちょく', question: '非常に真面目で、正直なこと。', explanation: '折り目正しい様子。', distractors: ['不', '良', '怠', '慢', '軽', '薄', '不', '真'] },
          { answer: '呉越同舟', reading: 'ごえつどうしゅう', question: '仲の悪い者同士が協力すること。', explanation: '敵対関係にある者が同席する。', distractors: ['親', '友', '固', '執', '拒', '絶', '孤', '独'] }
        ]
      };

      const LEVELS = [
        { id: 'elementary_low', label: '小学生低学年', description: '基本中の基本！数字や簡単な漢字の四字熟語' },
        { id: 'elementary_high', label: '小学生高学年', description: '教科書に出てくる有名な四字熟語' },
        { id: 'junior_high', label: '中学生', description: '一般常識として知っておきたいレベル' },
        { id: 'high_school', label: '高校生', description: '入試や文学作品に出てくる表現' },
        { id: 'adult', label: '大人', description: '新聞やビジネスで使える高度な四字熟語' },
      ];

      // --- パーツコンポーネント ---
      const DraggableKanji = ({ id, char, isOverlay }) => {
        const { attributes, listeners, setNodeRef, isDragging } = useDraggable({ id });
        const baseStyle = "w-14 h-14 sm:w-16 sm:h-16 lg:w-20 lg:h-20 text-2xl sm:text-3xl lg:text-4xl bg-white border-b-4 border-r-4 border-2 border-japan-indigo rounded-lg flex items-center justify-center font-black text-japan-indigo select-none touch-manipulation";
        const style = isOverlay ? "z-50 scale-110 rotate-6 shadow-2xl border-pop-cyan text-pop-cyan" : isDragging ? "opacity-20 scale-90" : "cursor-grab hover:-translate-y-1 transition-all";
        return <div ref={setNodeRef} {...listeners} {...attributes} className={`${baseStyle} ${style}`}>{char}</div>;
      };

      const AnswerSlot = ({ id, children, isCorrect }) => {
        const { setNodeRef, isOver } = useDroppable({ id });
        const sizeClasses = "w-14 h-14 sm:w-16 sm:h-16 lg:w-20 lg:h-20";
        let borderColor = isCorrect === true ? "border-pop-green" : isCorrect === false ? "border-japan-red" : isOver ? "border-pop-cyan" : "border-japan-indigo/20";
        let bgColor = isCorrect === true ? "bg-pop-green/20" : isCorrect === false ? "bg-japan-red/20" : isOver ? "bg-pop-cyan/20" : "bg-japan-indigo/5";
        return <div ref={setNodeRef} className={`${sizeClasses} rounded-xl border-4 border-dashed flex items-center justify-center transition-colors ${borderColor} ${bgColor}`}>{children}</div>;
      };

      // --- 画面コンポーネント ---
      const StartScreen = ({ onStart }) => {
        const [time, setTime] = useState(20);
        return (
          <div className="flex flex-col items-center space-y-8 animate-bounce-in py-6">
            <h1 className="text-5xl md:text-7xl font-black text-japan-indigo text-center">四字熟語<br /><span className="text-transparent bg-clip-text bg-gradient-to-r from-pop-cyan to-pop-purple">マスター</span></h1>
            <div className="w-full bg-white border-4 border-japan-indigo p-5 rounded-3xl shadow-hard">
              <div className="flex items-center gap-2 mb-4 font-black"><Clock className="w-5 h-5 text-pop-purple" />制限時間</div>
              <div className="grid grid-cols-4 gap-2">
                {[10, 20, 30, 0].map(t => <button key={t} onClick={() => setTime(t)} className={`py-2 rounded-xl font-black border-2 border-japan-indigo ${time === t ? 'bg-pop-purple text-white shadow-hard-sm' : 'bg-gray-50 text-gray-400'}`}>{t || 'なし'}{t ? '秒' : ''}</button>)}
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 w-full">
              {LEVELS.map((l, i) => (
                <button key={l.id} onClick={() => onStart(l.id, time)} className={`p-5 rounded-2xl bg-white border-4 border-japan-indigo text-left shadow-hard hover:-translate-y-1 transition-all ${i === LEVELS.length-1 ? 'md:col-span-2' : ''}`}>
                  <div className="flex justify-between items-start"><div className="font-black text-xl">{l.label}</div><span className="bg-japan-indigo text-white text-[10px] px-2 py-0.5 rounded-full font-black">LV.{i+1}</span></div>
                  <p className="text-xs font-bold text-gray-400 mt-1">{l.description}</p>
                </button>
              ))}
            </div>
          </div>
        );
      };

      const QuizScreen = ({ questions, timeLimit, onFinish }) => {
        const [idx, setIdx] = useState(0);
        const [score, setScore] = useState(0);
        const [items, setItems] = useState([]);
        const [slots, setSlots] = useState([null, null, null, null]);
        const [status, setStatus] = useState('unanswered');
        const [activeId, setActiveId] = useState(null);
        const [timeLeft, setTimeLeft] = useState(timeLimit);
        const sensors = useSensors(useSensor(MouseSensor), useSensor(TouchSensor, { activationConstraint: { delay: 0, tolerance: 5 } }));
        const q = questions[idx];

        useEffect(() => {
          if (!q) return;
          // 出題ごとに回答とダミーを混ぜてシャッフル
          const all = [
            ...q.answer.split('').map((c, i) => ({ id: `a-${idx}-${i}-${c}`, char: c })), 
            ...q.distractors.slice(0, 4).map((c, i) => ({ id: `d-${idx}-${i}-${c}`, char: c }))
          ].sort(() => Math.random() - 0.5);
          setItems(all); setSlots([null, null, null, null]); setStatus('unanswered'); setTimeLeft(timeLimit);
        }, [idx, q, timeLimit]);

        useEffect(() => {
          if (timeLimit > 0 && status === 'unanswered' && timeLeft > 0) {
            const t = setInterval(() => setTimeLeft(p => p - 0.1), 100);
            return () => clearInterval(t);
          }
        }, [timeLeft, status, timeLimit]);

        if (timeLimit > 0 && timeLeft <= 0 && status === 'unanswered') setStatus('wrong');

        const handleDragEnd = (e) => {
          setActiveId(null);
          if (!e.over || status !== 'unanswered') return;
          const tid = e.over.id;
          const sid = slots.findIndex(s => s === e.active.id);
          const next = [...slots];
          if (tid === 'pool') { if (sid !== -1) next[sid] = null; }
          else if (tid.startsWith('slot-')) {
            const targetIdx = parseInt(tid.split('-')[1]);
            if (sid !== -1) next[sid] = slots[targetIdx];
            next[targetIdx] = e.active.id;
          }
          setSlots(next);
        };

        const check = () => {
          const ans = slots.map(id => items.find(it => it.id === id)?.char || '').join('');
          if (ans === q.answer) { setStatus('correct'); setScore(s => s + 1); } else { setStatus('wrong'); }
        };

        return (
          <DndContext sensors={sensors} onDragStart={e => setActiveId(e.active.id)} onDragEnd={handleDragEnd}>
            <div className="w-full flex flex-col lg:flex-row gap-8 animate-fade-in min-h-[500px]">
              <div className="lg:w-1/2 space-y-4">
                <div className="flex justify-between font-black"><span className="bg-japan-indigo text-white px-3 py-1 rounded-full text-sm">Q.{idx+1}/{questions.length}</span><div className="bg-white px-3 py-1 rounded-full border-2 border-japan-indigo flex items-center gap-2 shadow-hard-sm"><Trophy className="w-4 h-4 text-pop-yellow fill-current" />{score}PT</div></div>
                <div className="bg-japan-indigo rounded-3xl p-8 border-4 border-japan-indigo shadow-hard text-white text-center h-48 lg:h-64 flex flex-col justify-center relative overflow-hidden">
                  <h2 className="text-2xl md:text-3xl font-black leading-snug">{q.question}</h2>
                  {timeLimit > 0 && status === 'unanswered' && <div className={`mt-4 font-black ${timeLeft < 5 ? 'text-japan-red' : 'text-pop-cyan'}`}>{Math.max(0, timeLeft).toFixed(1)}s</div>}
                </div>
              </div>
              <div className="lg:w-1/2 flex flex-col items-center gap-6">
                <div className="flex gap-2">{slots.map((id, i) => <AnswerSlot key={i} id={`slot-${i}`} isCorrect={status === 'unanswered' ? null : status === 'correct'}>{id && <DraggableKanji id={id} char={items.find(it => it.id === id).char} />}</AnswerSlot>)}</div>
                <div className="h-12 flex items-center">
                  {status === 'unanswered' ? (slots.every(s => s) ? <button onClick={check} className="bg-pop-cyan border-4 border-japan-indigo px-8 py-2 rounded-xl font-black shadow-hard-sm hover:-translate-y-1 transition-all">決定！</button> : <p className="text-gray-400 font-bold">解答を完成させてください</p>) : (
                    <div className="flex gap-4"><div className={`px-6 py-2 rounded-xl font-black border-4 border-japan-indigo ${status === 'correct' ? 'bg-pop-green text-japan-indigo' : 'bg-japan-red text-white'}`}>{status === 'correct' ? '正解！' : '残念...'}</div><button onClick={() => idx < questions.length - 1 ? setIdx(p => p + 1) : onFinish(score)} className="bg-japan-indigo text-white px-6 py-2 rounded-xl font-black flex items-center gap-2 hover:opacity-90">{idx < questions.length - 1 ? '次へ' : '結果発表'} <ChevronRight className="w-4 h-4" /></button></div>
                  )}
                </div>
                <div className="w-full bg-white border-4 border-dashed border-gray-200 rounded-3xl p-6 min-h-[220px] flex justify-center items-center shadow-inner">
                  {status === 'unanswered' ? <div className="grid grid-cols-4 gap-4">{items.filter(it => !slots.includes(it.id)).map(it => <DraggableKanji key={it.id} id={it.id} char={it.char} />)}</div> : (
                    <div className="text-center animate-fade-in"><div className="text-4xl font-black text-japan-indigo tracking-widest">{q.answer}</div><div className="text-pop-purple font-bold mt-1">{q.reading}</div><p className="mt-3 text-xs font-bold text-gray-500 bg-gray-50 p-2 rounded-lg">{q.explanation}</p></div>
                  )}
                </div>
              </div>
            </div>
            <DragOverlay className="drag-overlay-card">{activeId ? <DraggableKanji id={activeId} char={items.find(i => i.id === activeId).char} isOverlay /> : null}</DragOverlay>
          </DndContext>
        );
      };

      const ResultScreen = ({ score, total, questions, onRestart }) => (
        <div className="w-full max-w-2xl mx-auto animate-bounce-in space-y-8 pb-10">
          <div className="bg-japan-indigo rounded-3xl p-8 text-center border-4 border-japan-indigo shadow-hard text-white">
            <Trophy className="w-12 h-12 fill-pop-yellow text-japan-indigo mx-auto mb-4 bg-white p-2 rounded-full" />
            <h2 className="text-4xl font-black italic mb-6">RESULT</h2>
            <div className="flex justify-center gap-10 mb-8"><div className="text-center"><p className="text-xs font-bold text-gray-400">SCORE</p><p className="text-5xl font-black">{score}/{total}</p></div></div>
            <button onClick={onRestart} className="bg-pop-cyan text-japan-indigo px-10 py-3 rounded-xl font-black text-lg border-b-4 border-r-4 border-white shadow-hard flex items-center gap-2 mx-auto active:translate-y-1 active:shadow-none transition-all"><RefreshCcw className="w-5 h-5" /> REPLAY</button>
          </div>
          <div className="space-y-3">{questions.map((q, i) => <div key={i} className="bg-white p-4 rounded-xl border-2 border-japan-indigo shadow-hard-sm flex gap-4"><span className="w-8 h-8 rounded bg-japan-indigo text-white flex items-center justify-center font-black flex-shrink-0">{i+1}</span><div><p className="text-xl font-black text-japan-indigo">{q.answer} <span className="text-sm font-bold text-pop-purple ml-2">{q.reading}</span></p><p className="text-xs font-bold text-gray-500">{q.explanation}</p></div></div>)}</div>
        </div>
      );

      // --- メインアプリ ---
      const App = () => {
        const [state, setState] = useState('START');
        const [questions, setQuestions] = useState([]);
        const [score, setScore] = useState(0);
        const [time, setTime] = useState(20);

        const start = (levelId, limit) => {
          setState('LOADING'); setTime(limit);
          setTimeout(() => {
            const fullPool = IDIOM_DATABASE[levelId] || IDIOM_DATABASE['elementary_low'];
            const shuffled = [...fullPool].sort(() => Math.random() - 0.5);
            setQuestions(shuffled.slice(0, 5)); 
            setState('QUIZ'); setScore(0);
          }, 1000);
        };

        return (
          <div className="min-h-screen flex flex-col items-center p-4 w-full">
            <header className="w-full max-w-5xl mx-auto p-4 flex justify-between items-center z-10">
              <div onClick={() => setState('START')} className="flex items-center gap-2 text-japan-indigo cursor-pointer bg-white px-4 py-2 rounded-full border-2 border-japan-indigo shadow-hard-sm hover:opacity-90">
                <div className="bg-pop-cyan p-1 rounded-full text-white"><Zap className="w-4 h-4 fill-current" /></div>
                <span className="font-black text-sm tracking-tighter uppercase">Yoji-Master</span>
              </div>
            </header>
            <main className="w-full max-w-5xl mx-auto flex-grow flex flex-col justify-center">
              {state === 'START' && <StartScreen onStart={start} />}
              {state === 'LOADING' && <div className="text-center animate-fade-in"><div className="bg-white p-8 rounded-2xl border-4 border-japan-indigo shadow-hard animate-bounce mb-6 inline-block"><Brain className="w-12 h-12 text-pop-purple" /></div><p className="font-black text-japan-indigo text-xl">問題を準備中...</p></div>}
              {state === 'QUIZ' && <QuizScreen questions={questions} timeLimit={time} onFinish={s => { setScore(s); setState('RESULT'); }} />}
              {state === 'RESULT' && <ResultScreen score={score} total={questions.length} questions={questions} onRestart={() => setState('START')} />}
            </main>
            <footer className="mt-8 mb-4 text-[10px] font-bold text-gray-400 text-center uppercase tracking-widest opacity-50">Standalone Quiz Engine (Strict 1-Kanji Card Version)</footer>
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
